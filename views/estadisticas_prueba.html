{% extends "layout.html" %}
{% block body %}
<div class="margin-top-110">
  <div class="container">
    <br>

    <div  class="flex justify-content-between">
      <h1 class="fs-4">Ganancias totales</h1>

      <!--NOMBRE DE LAS ESTADISTICAS QUE SE ESTA MOSTRANDO-->
      <div >
        <select name="graficasPrincipales" id="graficasPrincipales" class="card-style" onchange="cambiarRaizRuta()" >
          <option value="/estadisticas/ganancias" {% if raizRuta == "ganancias" %} selected {% endif %} >Ganancias totales</option>
          <option value="/estadisticas/ganancias_de_servicio" {% if raizRuta == "ganancias_de_servicio" %} selected {% endif %} >Ganancias por instrumento</option>
          <option value="/estadisticas/cantidad_de_servicio" {% if raizRuta == "cantidad_de_servicio" %} selected {% endif %} >Cantidad de servicios</option>
        </select>
        
        <select name="filtroTiempo" id="filtroTiempo" onchange="cambiarFiltroTiempo()">
          <option value="por_anio" {% if filtroTiempo == "por_anio" %} selected {% endif %}>Años</option>
          <option class="btn-group dropright" value="por_mes" {% if filtroTiempo == "por_mes" %} selected {% endif %}>Meses</option>
        </select>
        
        {% if aniosDisponibles %}
          <select name="aniosDisponibles" id="aniosDisponibles" onchange="cambiarAnio()" >
            {% for anio in aniosDisponibles %}
              <option value="{{anio.anio}}" {% if anio.anio == anioSeleccionado %} selected {% endif %} >{{anio.anio}}</option>
            {% endfor %}
          </select>
        {% endif %}
        
        {% if instrumentos %}
          <select name="instrumentos" id="instrumentos" onchange="cambiarInstrumento()" >
            {% for instrumento in instrumentos %}
              <option value="{{instrumento.id}}" {% if instrumento.nombre_instrumento == instrumentoSeleccionado %} selected {% endif %} >{{instrumento.nombre_instrumento}}</option>
            {% endfor %}
          </select>
        {% endif %}
      </div>
      
    </div>

    <div class="flex justify-content-between" >

      <div class="box-area " >
      <canvas id="myChart"></canvas>
      <br>
      <br>
      <!--TABLA CON RESUMEN DE TODOS LOS DATOS-->
      <!-- MES GANANCIA-->
     
      <br>
      <br>
    </div>

    <div class="right-box">

        
          
          {% if datosGrafica | isEmpty %}
          <h5>No hay datos</h5>
          {% else %}
          <table class="table table-borderless table-hover">
            <thead>
              <tr>ganancias totales</tr>
          </thead>
            <tr>
              {% if filtroTiempo == "por_anio" %}
                <th>Año</th>
        
              {% else %}
                <th>Mes</th>
              {% endif %}
              {% if raizRuta == "ganancias" or raizRuta =="ganancias_de_servicio" %}  
                <th>Ganancia</th>
              {% else %}
                <th>Cantidad</th>
              {% endif %}
            </tr>
            {% for etiqueta, valor in datosGrafica %}
              <tr>
                <td>{{etiqueta}}</td>
                <td>{{valor}}</td>
              </tr>
            {% endfor %}
            
            
          </table>
        
        {% endif %}
        
      
    </div>


    </div>

  </div>
</div>



<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="
https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js
"></script>
<script>
  const ctx = document.getElementById('myChart');


let data = {
  //labels: ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5', 'Day 6'], //datos del eje x
  datasets: [
    {
      label: '{{datasetName}}', //datos mostrados en la grafica
      data: {{ datosGrafica | dump | safe }}, // datos del eje y
      borderColor: "#024164",
      backgroundColor: "#024164",
      pointStyle: 'circle',
      pointRadius: 10,
      pointHoverRadius: 15
    }
  ]
};
let config = {
  type: 'line',
  data: data,
  options: {
    responsive: true,
    plugins: {
      title: {
        display: true,
        text: '{{tituloGrafica}}', //titulo de la grafica
      }
    }
  }
};

  let grafica = new Chart(ctx, config);

    function cambiarFiltroTiempo() {
      //mostrar links
      let filtroTiempo = document.getElementById("filtroTiempo").value;
      let ruta = window.location.pathname;
      let elementosRuta = ruta.split('/');
      elementosRuta[3] = filtroTiempo;
      console.log("RUTA ANTES DE QUITAR EXCEDENTE: " + elementosRuta.join('/'));
      while(elementosRuta.length > 4){
        elementosRuta.pop();
      }
      console.log("RUTA DESPUES DE QUITAR EXCEDENTE: " + elementosRuta.join('/'));

      let nuevaRuta = elementosRuta.join('/');
      console.log(nuevaRuta);
      window.location.href = nuevaRuta;
      
     
      
        
    }
    

    function cambiarAnio() {
      var elementosRuta = window.location.pathname.split('/');
      elementosRuta[4] = document.getElementById("aniosDisponibles").value;
      var url =  elementosRuta.join('/'); // Obtener el valor de la opción seleccionada
      console.log(url);
      if(url) { // Verificar si el valor no está vacío
        window.location.href = url; // Redireccionar a la URL
      }
    }

    function cambiarInstrumento() {
      let elementosRuta = window.location.pathname.split('/');
      elementosRuta[4] = document.getElementById("instrumentos").value;
      if(elementosRuta.length > 5){
        elementosRuta.pop();
        }
      var url = elementosRuta.join('/'); // Obtener el valor de la opción seleccionada
    

      console.log(url);
      if(url) { // Verificar si el valor no está vacío
        window.location.href = url; // Redireccionar a la URL
      }
    }

   

    function cambiarRaizRuta(){
      const filtroTiempo = document.getElementById('filtroTiempo').value;
      const rutaBase = document.getElementById('graficasPrincipales').value;
      let nuevaRuta = rutaBase + '/' + filtroTiempo;
      
      window.location.href = nuevaRuta; // Redireccionar a la URL
      
    }
</script>
{% endblock %}